package main

import (
	"context"
	"fmt"
	"time"

	"github.com/everydayItems/gopkg/infra/queue/asynq"
	asq "github.com/hibiken/asynq"
)

func main() {
	fmt.Println("=== Asynq ä»»åŠ¡é˜Ÿåˆ—ç¤ºä¾‹ ===\n")

	// 1. é…ç½®æ—¥å¿—å’Œé…ç½®æä¾›è€…
	logger := &CustomLogger{}
	configProvider := &CustomConfig{
		redisAddrs:     []string{"localhost:6379"},
		redisPassword:  "",
		concurrency:    10,
		pollingEnabled: true,
		redisEnabled:   true,
	}

	asynq.SetLogger(logger)
	asynq.SetConfigProvider(configProvider)

	fmt.Println("âœ… é…ç½®å·²è®¾ç½®")
	fmt.Println("   Redis: localhost:6379")
	fmt.Println("   Concurrency: 10\n")

	// 2. åˆå§‹åŒ–ç®¡ç†å™¨
	manager, err := asynq.InitManagerFromConfig(configProvider)
	if err != nil {
		fmt.Printf("âŒ åˆå§‹åŒ–å¤±è´¥: %v\n", err)
		return
	}

	fmt.Println("âœ… Manager åˆå§‹åŒ–æˆåŠŸ\n")

	// 3. æ³¨å†Œä»»åŠ¡å¤„ç†å™¨
	manager.RegisterHandler("email:send", handleEmailTask)
	manager.RegisterHandler("report:generate", handleReportTask)

	fmt.Println("âœ… ä»»åŠ¡å¤„ç†å™¨å·²æ³¨å†Œ")
	fmt.Println("   - email:send")
	fmt.Println("   - report:generate\n")

	// 4. å¯åŠ¨ Worker
	ctx := context.Background()
	if err := manager.Start(ctx); err != nil {
		fmt.Printf("âŒ å¯åŠ¨å¤±è´¥: %v\n", err)
		return
	}

	fmt.Println("âœ… Worker å·²å¯åŠ¨\n")

	// 5. å…¥é˜Ÿä»»åŠ¡
	fmt.Println("ğŸ“¤ å…¥é˜Ÿä»»åŠ¡...")

	// ç®€å•ä»»åŠ¡
	task1 := asynq.NewTask("email:send").
		Payload(map[string]string{"to": "user@example.com", "subject": "Hello"}).
		Queue(asynq.QueueHigh).
		MaxRetry(3)

	info1, err := task1.Enqueue(ctx)
	if err != nil {
		fmt.Printf("âŒ å…¥é˜Ÿå¤±è´¥: %v\n", err)
	} else {
		fmt.Printf("   âœ… ä»»åŠ¡ 1 å·²å…¥é˜Ÿ: ID=%s, Queue=%s\n", info1.ID, info1.Queue)
	}

	// å»¶è¿Ÿä»»åŠ¡
	task2 := asynq.NewTask("report:generate").
		Payload(map[string]interface{}{"type": "monthly", "month": "2024-01"}).
		ProcessIn(5 * time.Second).
		Queue(asynq.QueueDefault)

	info2, err := task2.Enqueue(ctx)
	if err != nil {
		fmt.Printf("âŒ å…¥é˜Ÿå¤±è´¥: %v\n", err)
	} else {
		fmt.Printf("   âœ… ä»»åŠ¡ 2 å·²å…¥é˜Ÿ: ID=%s, 5ç§’åå¤„ç†\n", info2.ID)
	}

	fmt.Println("\nâ³ ç­‰å¾…ä»»åŠ¡å¤„ç†...")
	time.Sleep(10 * time.Second)

	// 6. åœæ­¢
	fmt.Println("\nğŸ›‘ åœæ­¢ Worker...")
	manager.Stop()

	fmt.Println("\nâœ… ç¤ºä¾‹å®Œæˆ!")
}

// =========================================
// ä»»åŠ¡å¤„ç†å™¨
// =========================================

func handleEmailTask(ctx context.Context, t *asq.Task) error {
	fmt.Printf("ğŸ“§ å¤„ç†é‚®ä»¶ä»»åŠ¡: ID=%s\n", t.Type())
	time.Sleep(1 * time.Second)
	return nil
}

func handleReportTask(ctx context.Context, t *asq.Task) error {
	fmt.Printf("ğŸ“Š å¤„ç†æŠ¥å‘Šä»»åŠ¡: ID=%s\n", t.Type())
	time.Sleep(2 * time.Second)
	return nil
}

// =========================================
// è‡ªå®šä¹‰å®ç°
// =========================================

type CustomLogger struct{}

func (l *CustomLogger) Log(msg string) {
	fmt.Println("[LOG]", msg)
}

func (l *CustomLogger) LogSkip(skip int, msg string) {
	fmt.Println("[LOG]", msg)
}

func (l *CustomLogger) Error(msg string) {
	fmt.Println("[ERROR]", msg)
}

func (l *CustomLogger) ErrorSkip(skip int, msg string) {
	fmt.Println("[ERROR]", msg)
}

type CustomConfig struct {
	redisAddrs     []string
	redisPassword  string
	concurrency    int
	pollingEnabled bool
	redisEnabled   bool
}

func (c *CustomConfig) IsRedisEnabled() bool {
	return c.redisEnabled
}

func (c *CustomConfig) GetRedisAddrs() []string {
	return c.redisAddrs
}

func (c *CustomConfig) GetRedisPassword() string {
	return c.redisPassword
}

func (c *CustomConfig) GetRedisUsername() string {
	return ""
}

func (c *CustomConfig) GetConcurrency() int {
	return c.concurrency
}

func (c *CustomConfig) GetQueuePrefix() string {
	return ""
}

func (c *CustomConfig) IsPollingEnabled() bool {
	return c.pollingEnabled
}
